<!DOCTYPE html>
<html>
<head>
    <title>DEIMS SDR - OpenLayers example</title>
    <meta charset="utf-8" />
    <title>Single Image WMS</title>
    <link rel="stylesheet" href="https://openlayers.org/en/v4.3.2/css/ol.css" type="text/css">
	<link href='https://fonts.googleapis.com/css?family=Open Sans' rel='stylesheet'>
	
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://openlayers.org/en/v4.3.2/build/ol.js"></script>
	<script src="js/jquery-3.2.1.min.js"></script>
	<script src="js/lodash.min.js"></script>
	<script src="js/xml2json.min.js"></script>
	<script src="js/xml2json.js"></script>
	
	<style>
        body {
            padding: 0;
            margin: 0;
        }
        html, body, #map {
            height: 100%;
            width: 100%;
        }
		#map {
			  width: 100%;
			  height: 100%;
			  position: absolute;
			  top: 0;
			  left: 0;
		}
		.ol-popup {
			position: absolute;
			background-color: white;
			-webkit-filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
			filter: drop-shadow(0 1px 4px rgba(0,0,0,0.2));
			padding: 15px;
			border-radius: 10px;
			border: 1px solid #cccccc;
			bottom: 12px;
			left: -50px;
			min-width: 280px;
			font-family: 'Open Sans';
		}
      .ol-popup:after, .ol-popup:before {
        top: 100%;
        border: solid transparent;
        content: " ";
        height: 0;
        width: 0;
        position: absolute;
        pointer-events: none;
      }
      .ol-popup:after {
        border-top-color: white;
        border-width: 10px;
        left: 48px;
        margin-left: -10px;
      }
      .ol-popup:before {
        border-top-color: #cccccc;
        border-width: 11px;
        left: 48px;
        margin-left: -11px;
      }
      .ol-popup-closer {
        text-decoration: none;
        position: absolute;
        top: 2px;
        right: 8px;
      }
      .ol-popup-closer:after {
        content: "âœ–";
      }

    </style>
	
</head>
<body>
    <div id="map" class="map"></div>
	<div id="popup" class="ol-popup">
      <a href="#" id="popup-closer" class="ol-popup-closer"></a>
      <div id="popup-content"></div>
    </div>
    <script>
	
	/**
     * Elements that make up the popup.
     */
    var container = document.getElementById('popup');
    var content = document.getElementById('popup-content');
    var closer = document.getElementById('popup-closer');


    /**
     * Create an overlay to anchor the popup to the map.
     */
    var overlay = new ol.Overlay(/** @type {olx.OverlayOptions} */ ({
		element: container,
		autoPan: true,
		autoPanAnimation: {
			duration: 250
        }
    }));
	  
	  
    /**
     * Add a click handler to hide the popup.
     * @return {boolean} Don't follow the href.
     */
    closer.onclick = function() {
		overlay.setPosition(undefined);
        closer.blur();
		vectorSource.clear();
        return false;
    };
	
	 var fill = new ol.style.Fill({
	   color: 'rgba(255,153,51,0.75)'
	 });
	 var stroke = new ol.style.Stroke({
	   color: '#FFFFFF',
	   width: 1.25
	 });
	
	var styles = [
	   new ol.style.Style({
		 image: new ol.style.Circle({
		   fill: fill,
		   stroke: stroke,
		   radius: 5
		 }),
		 fill: fill,
		 stroke: stroke
	   })
	 ];
	
	
	var vectorSource = new ol.source.Vector({});
	var point_layer = new ol.layer.Vector({
        source: vectorSource,
		style: styles,
		projection: 'EPSG:3857',
    });
	
	
	 var wmsSource = new ol.source.TileWMS({
        url: 'https://data.lter-europe.net/geoserver/deims/wms?',
        params: {'LAYERS': 'deims:lter_eu_formal'},
        ratio: 1,
        serverType: 'geoserver',
    });
       

    var wmsLayer = new ol.layer.Tile({
        source: wmsSource
    });	
	
    var osm = [
        new ol.layer.Tile({
			source: new ol.source.OSM()
        }),
        wmsLayer
    ];
	  
	  
	  
	var view = new ol.View({
		projection: 'EPSG:3857',
		center: [1929025.946814, 7494089.923109],
		zoom: 4
    });
	  
    var map = new ol.Map({
		layers: osm,
		overlays: [overlay],
        target: 'map',
        view: view
    });
	map.addLayer(point_layer)
	
	/**
     * Add a click handler to the map to render the popup.
     */
    map.on('singleclick', function(evt) {
		var viewResolution = /** @type {number} */ (view.getResolution());
        var url = wmsSource.getGetFeatureInfoUrl(
            evt.coordinate, viewResolution, 'EPSG:3857',
            {'INFO_FORMAT': 'application/json'});
         
		if (url) {
		  
			$.getJSON(url, function(data) {
			
				var features = data["features"];
				
				if (features[0]){  
					var properties = features[0];
					var information_obj = properties["properties"];
					var site_url = "<a href='https://data.lter-europe.net/deims/site/" + information_obj["uuid"] + "' target='_blank'>Record on DEIMS-SDR</a>";
					var ef_url = "<a href='https://data.lter-europe.net/deims/node/" + information_obj["nid"] + "/emf' target='_blank'>EF record</a>";
					var ef_address = "https://data.lter-europe.net/deims/node/" + information_obj["nid"] + "/emf";
					
					content.innerHTML = "<b>" + information_obj["name"] + "</b><br>" + "uuid: " + information_obj["uuid"] + "<br>" + "Classification: " + information_obj["classification"] + "<br>" + "url: " + site_url;
					content.innerHTML += '<br>' + ef_url;
					content.innerHTML += "<a id='something'>Click box</a>";
					
					var current_coords = ol.proj.transform([information_obj["field_coordinates_lon"], information_obj["field_coordinates_lat"]], 'EPSG:4326','EPSG:3857');
				
					overlay.setPosition(current_coords);
					
					var selected_site = new ol.Feature({
						geometry: new ol.geom.Point(current_coords),
					}); 
					
					vectorSource.clear();
					vectorSource.addFeature(selected_site);
					
					// Listener for details 
					$('#something').click( function() { 
						parse_ef(ef_address); 
					})
					
				};
				
			
			});	  
        }
        
    });
	
	// function for parsing the ef	
	function parse_ef(ef_address) {
	
		var x = new XMLHttpRequest();
		x.open("GET", ef_address, true);
		x.onreadystatechange = function () {
		  if (x.readyState == 4 && x.status == 200)
		  {
			var doc = x.responseXML;
			var x2js = new X2JS();
			jsonObj = x2js.xml2json(doc);
			var ef_content = jsonObj["EnvironmentalMonitoringFacility"];
			var ef_geometry = ef_content["geometry"];
			
			var multi_geom = ef_geometry["MultiGeometry"];
			
			var geom_poly = multi_geom["geometryMember"];
			console.log("parse_ef");
			var polygon = geom_poly[0];
			var poly2 = polygon["Polygon"];
			var exterior = poly2["exterior"];
			var lin_ring = exterior["LinearRing"];
			var pos_list = lin_ring["posList"];
			var __text = pos_list["__text"];
			
			
			var geom_array = __text.split(' ');
			console.log('geom array length' + geom_array.length);
			
			coords_array = [];
			
			for (i = 0; i < geom_array.length; i+=2) { 
				coords_array.push(ol.proj.transform([geom_array[i+1]*1, geom_array[i] * 1], 'EPSG:4326', 'EPSG:3857'));
			}
			var linearRing = new ol.geom.LinearRing(coords_array);
			console.log("linearRing");	
			console.log(linearRing);		
			
			var poly_feature = new ol.Feature({
				geometry: new ol.geom.Polygon([coords_array])
			});
			
			vectorSource.addFeature(poly_feature);
			
			
			var feature = vectorSource.getFeatures()[0];
			var zoom_polygon = /** @type {ol.geom.SimpleGeometry} */ (feature.getGeometry());
			
			//view.fit(zoom_polygon, {padding: [170, 50, 30, 150], constrainResolution: false});
			//view.fit(zoom_polygon, {padding: [170, 50, 30, 150]});
			view.fit(zoom_polygon, {duration: 2000}, {padding: [0, 0, 0, 0]});
			
			
			
		  }
		};
		x.send(null);

		return true;             
	}  
	  
	// so slow and not elegant
	/*
	var target = map.getTarget();
	var jTarget = typeof target === "string" ? $("#" + target) : $(target);
	
	map.on('pointermove', function (evt) {
		var viewResolution = (view.getResolution());
        var url = wmsSource.getGetFeatureInfoUrl(
            evt.coordinate, viewResolution, 'EPSG:3857',
            {'INFO_FORMAT': 'application/json'});
         
		if (url) {
		  
			$.getJSON(url, function(data) {
			
				var features = data["features"];
				
				if(features[0]){  
					jTarget.css("cursor", "pointer");
				}
				else {
					jTarget.css("cursor", "");
				}
				
			});	  
        }
	}); */
	
	
    </script>
</body>
</html>
